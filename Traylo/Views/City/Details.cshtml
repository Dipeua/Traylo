@model City

@{
    ViewData["Title"] = "Détails de la ville";
}

<div class="container-fluid">

    <div class="card shadow mb-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="m-0 font-weight-bold">Ville : @Model.Name</h5>
            <span class="badge bg-light text-primary fs-6">Livreurs : @(Model.DeliveryPeople?.Count() ?? 0)</span>
        </div>

        <div class="card-body">

            <h6 class="mt-3 mb-3 text-primary"><i class="fas fa-truck"></i> Livreurs actifs dans cette ville</h6>

            @if (Model.DeliveryPeople != null && Model.DeliveryPeople.Any())
            {
                <div class="table-responsive mb-4">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nom</th>
                                <th>Téléphone</th>
                                <th>Produits Reçu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var delivery in Model.DeliveryPeople)
                            {
                                <tr>
                                    <td>@delivery.FullName</td>
                                    <td>@delivery.PhoneNumber</td>
                                    <td>
                                        @{
                                            var productsDelivered = delivery.StockHistories?
                                            .GroupBy(sh => sh.ProductId)
                                            .Select(g => new
                                            {
                                                ProductName = g.First().Product?.Name,
                                                TotalQuantity = g.Sum(x => x.QuantityChange)
                                            })
                                            .ToList();
                                        }

                                        @if (productsDelivered != null && productsDelivered.Any())
                                        {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var item in productsDelivered)
                                                {
                                                    <li><i class="fas fa-box text-success me-1"></i>@item.ProductName (@item.TotalQuantity reçu)</li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Aucun produit associé</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning">Aucun livreur pour cette ville.</div>
            }

            <h6 class="mt-4 mb-3 text-primary"><i class="fas fa-warehouse"></i> Produits distribués directement dans cette ville</h6>

            @if (Model.StockHistories != null && Model.StockHistories.Any(sh => sh.CityId == Model.CityId))
            {
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Produit</th>
                                <th>Quantité distribuée</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.StockHistories.Where(sh => sh.CityId == Model.CityId))
                            {
                                <tr>
                                    <td>@item.Product?.Name</td>
                                    <td>@item.QuantityChange</td>
                                    <td>@item.Date.ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">Aucun produit distribué pour cette ville.</div>
            }

            <div class="mt-4 d-flex gap-2">
                <a asp-controller="City" asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour à la liste
                </a>
                <a asp-controller="City" asp-action="Edit" asp-route-CityId="@Model.CityId" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Modifier
                </a>
            </div>

        </div>
    </div>
</div>
